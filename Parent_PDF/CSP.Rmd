
---
output: 
  bookdown::pdf_document2:
    includes:
      in_header: preamble.tex
    pandoc_args: 
      - "--metadata-file=../Header/header_common.yaml"
      - '--lua-filter=../Filters/scholarly-metadata.lua'
      - '--lua-filter=../Filters/author-info-blocks.lua'
    toc: no
date: "`r format(Sys.Date(),'%d %B %Y')`"
params:
  eval_1L_lgl: True
  X: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = params$eval_1L_lgl)
```

\blandscape
<!---BLOCK_LANDSCAPE_START--->

# About this code
When using this code it is important to note:

1) Some of the steps in this program involve interactivity - they generate a prompt that a user must respond to before proceeding. Therefore, this code should be run step by step (i.e run one chunk at a time and do not knit if you are using the kdown version of this code).

2) The code is implemented in R using [ready4 framework](https://ready4-dev.github.io/ready4/) modules for

- labeling, validating and summarising youth mental health datasets from the [youthvars](https://ready4-dev.github.io/youthvars/) package;
- scoring health utility from the [scorz](https://ready4-dev.github.io/scorz/) package;
- specifying and testing statistical models from the [specific](https://ready4-dev.github.io/specific/) package;
- generating reports from the [ready4show](https://ready4-dev.github.io/ready4show/)  package; and
- sharing data via online data repositories from the [ready4use](https://ready4-dev.github.io/ready4use/)  package; and
- implementing a utility mapping study from the [TTU](https://ready4-dev.github.io/TTU/) package.

3) The code in this program is highly abstracted which means that its detailed workings are not exposed. However, as all code is open source you are able to scrutinise the underlying code if you wish. The websites, manuals and repositories of the ready4 framework libraries used in this analysis are a good starting point. 

# Install and load required libraries
If you do not already have the required libraries to run this program installed, you can do so by un-commenting and running the following lines.

```{r }
# devtools::install_github("ready4-dev/ready4) 
# devtools::install_github("ready4-dev/TTU") 
```

Next load the libraries required to run this program.

```{r message=FALSE, warning=FALSE}
library(ready4)
library(ready4use)
library(youthvars)
library(scorz)
library(TTU)
```

Source functions that we will use later.

```{r}
source("../R/Functions.R")
```

# Ingest, transform, label and score data

## Ingest data
To start, we need to specify the path to our input dataset. The setting below (empty) will allow you to run the program for an illustrative **replication** study using a synthetic dataset that, though entirely fake, closely resembles the study dataset. However, if you have access to the source dataset and wish to use it to **reproduce** our study, you can instead specify the path to that data here.

```{r eval=FALSE}
#path_to_data_1L_chr <- NA_character_ # Replace with path to data if you have access to it
```

Based on the value specified above, we can now ingest either the real study dataset or the synthetic (fake) data. We perform a number of data transformations (using the `transform_csnl_example_ds` function) to prepare the dataset for analysis and then pair the dataset with its data dictionary as a `Ready4useDyad`.

```{r}
A <- Ready4useDyad(ds_tb = {if(!is.na(path_to_data_1L_chr)){readRDS(path_to_data_1L_chr)
  }else{Ready4useRepos(dv_nm_1L_chr = "fakes",
                       dv_ds_nm_1L_chr = "https://doi.org/10.7910/DVN/HJXYKQ",
                       dv_server_1L_chr = "dataverse.harvard.edu") %>%
      ingest(fls_to_ingest_chr = c("SPECIFY_FILE_NAME_WHEN_WRITTEN"),
             metadata_1L_lgl = F)}} %>% transform_csnl_example_ds(),
  dictionary_r3 = Ready4useRepos(dv_nm_1L_chr = "TTU",
                                 dv_ds_nm_1L_chr = "https://doi.org/10.7910/DVN/FDRUXH",
                                 dv_server_1L_chr = "dataverse.harvard.edu") %>%
    ingest(fls_to_ingest_chr = c("ymh_clinical_aqol_chu_dict_r3"),
           metadata_1L_lgl = F)
  ) 
A <- A %>%
  renew_Ready4useDyad(type_1L_chr = "label") # MODIFY WHEN READY4USE LIBRARY IS UPDATED
```

We add some metadata about the structural properties of our dataset (variables for the unique record identifier and data collection round), using the `YouthvarsProfile` module.

```{r}
A <- YouthvarsProfile(a_Ready4useDyad = A,
                      id_var_nm_1L_chr = "fkClientID")
```


## Score health utility
We calculate adolescent AQoL-6D scores using the `ScorzAqol6Adol` module and save the dataset along with its metadata as a `TTUProject` module.

```{r}
A <- TTUProject(a_ScorzProfile = ScorzAqol6Adol(a_YouthvarsProfile = A))
#A <- renewSlot(A, "a_ScorzProfile") # Will replace subsequent line
A@a_ScorzProfile <- renew_ScorzAqol6Adol(A@a_ScorzProfile) # This is temporary
```

# Describe and analyse data

## Specify modelling parameters

We begin by reorganising some of the metadata we have already specified about our dataset.

```{r}
A <- renewSlot(A, "b_SpecificParameters", SpecificConverter(a_ScorzProfile = A@a_ScorzProfile) %>%
                 metamorphose() %>%
                 procureSlot("b_SpecificParameters"))
```

We add a table describing the candidate predictors that we will explore.

```{r}
# A <- renewSlot(A, "b_SpecificParameters@predictors_lup", Ready4useRepos(dv_nm_1L_chr = "TTU", 
#                                                                         dv_ds_nm_1L_chr = "https://doi.org/10.7910/DVN/FDRUXH", 
#                                                                         dv_server_1L_chr = "dataverse.harvard.edu") %>%
#                  ingest(fls_to_ingest_chr = c("predictors_r3"),
#                         metadata_1L_lgl = F)) 
A@b_SpecificParameters@predictors_lup <- make_csnl_example_predrs() # Temporary - Prior code preferred once scaling factor fixed.
```

We add the required parameters (allowable range for utility scores, the variable names of candidate predictors to be explored in the primary analysis, candidate covariates, variables to use when preparing descriptive statistics, the data collection date-stamp variable and metadata on candidate predictors).

```{r}
A <- renewSlot(A, "b_SpecificParameters@depnt_var_min_max_dbl", c(0.03,1)) %>% # Should be linked to ScorzClass
  renewSlot("b_SpecificParameters@candidate_predrs_chr", c("K10", "MLT", "SOFAS")) %>%
  renewSlot("b_SpecificParameters@candidate_covars_chr", c("d_gender", "d_age",  #"d_sexual_ori_s", 
                                                           "d_ATSI","CALD",
                                                           "c_days_cut_back",   "c_days_unable", 
                                                           #"d_studying_working", 
                                                           "c_p_diag_s" #"c_clinical_staging_s",
                                                          # "SOFAS"
                                                           )) %>%
  renewSlot("b_SpecificParameters@descv_var_nms_chr", c("d_age","d_gender",
                                                        "c_days_cut_back",   "c_days_unable", 
                                                        "d_employment_type","d_studying",#"d_studying_working", 
                                                        "c_p_diag_s", #"c_clinical_staging_s",
                                                        "s_IRSD","s_remoteness"
                                                        #"SOFAS"
                                                        )) 
# %>%  renewSlot("b_SpecificParameters@msrmnt_date_var_nm_1L_chr", "d_interview_date") 
```

## Create local workspace
We add details of the directory where data generated by our analysis will be written. Note, if using real data **this must be a secure location** as copies of the dataset will be saved in this directory.

```{r}
A <-  renewSlot(A, "b_SpecificParameters@fake_1L_lgl", T#ifelse(is.na(path_to_data_1L_chr),T,F)
                ) 
```
```{r}
A <- renewSlot(A, "c_SpecificProject", SpecificModels(a_YouthvarsProfile = A@a_ScorzProfile@a_YouthvarsProfile,
                                                      b_SpecificParameters = A@b_SpecificParameters,
                                                      paths_chr = {
                                                        if(is.na(path_to_data_1L_chr)){
                                                          tempdir()
                                                          }else{
                                                           normalizePath("../Data")
                                                          }
                                                        })) 
```

We confirm that our parameters and dataset are internally consistent. This step will also rename dataset variables that use certain incompatible naming conventions.

```{r}
A <- ratifySlot(A, "c_SpecificProject")
```
