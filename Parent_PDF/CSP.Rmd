
---
output: 
  bookdown::pdf_document2:
    includes:
      in_header: preamble.tex
    pandoc_args: 
      - "--metadata-file=../Header/header_common.yaml"
      - '--lua-filter=../Filters/scholarly-metadata.lua'
      - '--lua-filter=../Filters/author-info-blocks.lua'
    toc: no
date: "`r format(Sys.Date(),'%d %B %Y')`"
params:
  eval_1L_lgl: True
  X: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = params$eval_1L_lgl)
```

\blandscape
<!---BLOCK_LANDSCAPE_START--->

# About this code
When using this code it is important to note:

1) Some of the steps in this program involve interactivity - they generate a prompt that a user must respond to before proceeding. Therefore, this code should be run step by step (i.e run one chunk at a time and do not knit if you are using the kdown version of this code).

2) The code is implemented in R using [ready4 framework](https://ready4-dev.github.io/ready4/) modules for

- labeling, validating and summarising youth mental health datasets from the [youthvars](https://ready4-dev.github.io/youthvars/) package;
- scoring health utility from the [scorz](https://ready4-dev.github.io/scorz/) package;
- specifying and testing statistical models from the [specific](https://ready4-dev.github.io/specific/) package;
- generating reports from the [ready4show](https://ready4-dev.github.io/ready4show/)  package; and
- sharing data via online data repositories from the [ready4use](https://ready4-dev.github.io/ready4use/)  package; and
- implementing a utility mapping study from the [TTU](https://ready4-dev.github.io/TTU/) package.

3) The code in this program is highly abstracted which means that its detailed workings are not exposed. However, as all code is open source you are able to scrutinise the underlying code if you wish. The websites, manuals and repositories of the ready4 framework libraries used in this analysis are a good starting point. 

# Install and load required libraries
If you do not already have the required libraries to run this program installed, you can do so by un-commenting and running the following lines.

```{r }
# devtools::install_github("ready4-dev/ready4) 
# devtools::install_github("ready4-dev/TTU") 
```

Next load the libraries required to run this program.

```{r message=FALSE, warning=FALSE}
library(ready4)
library(ready4use)
library(youthvars)
library(scorz)
library(TTU)
```

# Ingest, transform, label and score data

## Ingest data
To start, we need to specify the path to our input dataset. The setting below (empty) will allow you to run the program for an illustrative **replication** study using a synthetic dataset that, though entirely fake, closely resembles the study dataset. However, if you have access to the source dataset and wish to use it to **reproduce** our study, you can instead specify the path to that data here.

```{r eval=FALSE}
#path_to_data_1L_chr <- NA_character_ # Replace with path to data if you have access to it
```

Based on the value specified above, we can now ingest either the real study dataset or the synthetic (fake) data. We perform a number of data transformations (using the `youthvars::transform_raw_ds_for_analysis` function) to prepare the dataset for analysis and then pair the dataset with its data dictionary as a `Ready4useDyad`.

```{r}
ds_tb <- readRDS(path_to_data_1L_chr) %>% tibble::as_tibble()
```
```{r}
ds_tb <- ds_tb %>%
  dplyr::rename(c_days_cut_back = K12_DaysCutDown,
                c_days_unable = K11_DaysTotallyUnable,
                c_MLT = MLT_mean, # Change
                c_p_diag_s = DiagnosisPrimary,
                d_age = Age,
                d_ATSI = ATSI,
                d_employed = Working,
                d_employment_type = EmploymentType,
                d_gender = Gender,
                d_studying = Studying,
                s_IRSD = IRSD,
                s_remoteness = Remoteness) %>%
  dplyr::select(-c("aqol6d_total_c",        "aqol6d_total_w"))
```

```{r}
dictionary_r3 <- Ready4useRepos(dv_nm_1L_chr = "TTU",
                               dv_ds_nm_1L_chr = "https://doi.org/10.7910/DVN/DKDIB0", 
                               dv_server_1L_chr = "dataverse.harvard.edu") %>% 
  ingest(fls_to_ingest_chr = c("dictionary_r3"), 
         metadata_1L_lgl = F) 
```

```{r}
dictionary_r3 <- dictionary_r3 %>%
  renew.ready4use_dictionary(var_nm_chr = setdiff(names(ds_tb),dictionary_r3$var_nm_chr) %>% sort(),
                             var_ctg_chr = c(rep("clinical symptom",3),
                                             rep("multi-attribute utility instrument question",9),
                                             "health_utility",
                                             rep("demographic",3),
                                             "psychological distress",
                                             rep("spatial",2)),
                             var_desc_chr = c("Days Unable To Perform Usual Activities",
                                             "Days Cut Back On Usual Activities",
                                             "My Life Tracker", # Change
                                             paste0("Child Health Utility (9 Dimension) question ",1:9),
                                             "Child Health Utility (9 Dimension) total score",
                                             "Employed",
                                             "Employment Type",
                                             "Studying",
                                             "Kessler Psychological Distress Scale (10 Item)",
                                            "Area Index of Relative Social Disadvantage",
                                             "Area Remoteness"
                                             ),
                             var_type_chr = NA_character_)
```

```{r}
# A <- Ready4useDyad(ds_tb = {if(!is.na(path_to_data_1L_chr)){readRDS(path_to_data_1L_chr)
#   }else{Ready4useRepos(dv_nm_1L_chr = "fakes", 
#                        dv_ds_nm_1L_chr = "https://doi.org/10.7910/DVN/HJXYKQ", 
#                        dv_server_1L_chr = "dataverse.harvard.edu") %>%
#       ingest(fls_to_ingest_chr = c("ymh_clinical_tb"), 
#              metadata_1L_lgl = F)}} %>% youthvars::transform_raw_ds_for_analysis(),
#   dictionary_r3 = Ready4useRepos(dv_nm_1L_chr = "TTU",
#                                  dv_ds_nm_1L_chr = "https://doi.org/10.7910/DVN/DKDIB0", 
#                                  dv_server_1L_chr = "dataverse.harvard.edu") %>% 
#     ingest(fls_to_ingest_chr = c("dictionary_r3"), 
#            metadata_1L_lgl = F)) %>%  
#   renew(type_1L_chr = "label")
```

We add some metadata about the structural properties of our dataset (variables for the unique record identifier and data collection round), using the `YouthvarsSeries` module.

```{r}
# A <- YouthvarsSeries(a_Ready4useDyad = A,
#                      id_var_nm_1L_chr = "fkClientID",
#                      timepoint_var_nm_1L_chr = "round",
#                      timepoint_vals_chr = levels(procureSlot(A,"ds_tb")$round))
```
