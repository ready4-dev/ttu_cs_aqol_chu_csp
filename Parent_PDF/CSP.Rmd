
---
output: 
  bookdown::pdf_document2:
    includes:
      in_header: preamble.tex
    pandoc_args: 
      - "--metadata-file=../Header/header_common.yaml"
      - '--lua-filter=../Filters/scholarly-metadata.lua'
      - '--lua-filter=../Filters/author-info-blocks.lua'
    toc: no
date: "`r format(Sys.Date(),'%d %B %Y')`"
params:
  eval_1L_lgl: True
  X: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = params$eval_1L_lgl)
```

\blandscape
<!---BLOCK_LANDSCAPE_START--->

# About this code
When using this code it is important to note:

1) Some of the steps in this program involve interactivity - they generate a prompt that a user must respond to before proceeding. Therefore, this code should be run step by step (i.e run one chunk at a time and do not knit if you are using the kdown version of this code).

2) The code is implemented in R using [ready4](https://ready4-dev.github.io/ready4/) modules for

- labeling, validating and summarising youth mental health datasets from the [youthvars](https://ready4-dev.github.io/youthvars/) package;
- scoring health utility from the [scorz](https://ready4-dev.github.io/scorz/) package;
- specifying and testing statistical models from the [specific](https://ready4-dev.github.io/specific/) package;
- generating reports from the [ready4show](https://ready4-dev.github.io/ready4show/)  package; and
- sharing data via online data repositories from the [ready4use](https://ready4-dev.github.io/ready4use/)  package; and
- implementing a utility mapping study from the [TTU](https://ready4-dev.github.io/TTU/) package.

3) The code in this program is highly abstracted which means that its detailed workings are not exposed. However, as all code is open source you are able to scrutinise the underlying code if you wish. The websites, manuals and repositories of the ready4 framework libraries used in this analysis are a good starting point. 

# Install and load required libraries
If you do not already have the required libraries to run this program installed, you can do so by un-commenting and running the following lines.

```{r }
# devtools::install_github("ready4-dev/ready4) 
# devtools::install_github("ready4-dev/TTU") 
```

Next load the libraries required to run this program.

```{r message=FALSE, warning=FALSE}
library(ready4)
library(ready4show)
library(ready4use)
library(youthvars)
library(scorz)
library(TTU)
```

Source functions that we will use later.

```{r}
source("../R/Functions.R")
```

# Ingest, transform, label and score data

## Specify data locations
To start, we need to specify the local and remote locations for storing project input and output data. The real study dataset (for study implementation and reproduction) can be read from a local location and fake data that closely resembles the study dataset (which are useful for algorithm testing and demonstration) can be read from either local or remote (i.e. online repository) locations. Note, if using real data, the local output directory **must be a secure location** as copies of the input dataset will be saved in this directory. Non-confidential analyses outputs will be shared via online repositories. Different repositories will be used for outputs created with real or fake data and which map to AQOL-6D or CHU-9D health utility.

```{r eval=FALSE}
is_real_1L_lgl <- F # 
#path_to_data_1L_chr <- "****Uncomment and replace with path to local data****"
path_to_output_1L_chr <- normalizePath("../Data")
repositories_ls <- purrr::map2(c(rep("TTU",2),rep("fakes",3)),
                                c("https://doi.org/10.7910/DVN/FDRUXH",
                                  "https://doi.org/10.7910/DVN/N4NEHL",
                                  "https://doi.org/10.7910/DVN/LYBMB0",
                                  "https://doi.org/10.7910/DVN/3R5TS3",
                                  "https://doi.org/10.7910/DVN/HJXYKQ"),
                                ~ Ready4useRepos(dv_nm_1L_chr = .x,
                                                 dv_ds_nm_1L_chr = .y,
                                                 dv_server_1L_chr = "dataverse.harvard.edu")) %>%
  stats::setNames(c("aqol_real_r4", "chu_real_r4","aqol_fake_r4", "chu_fake_r4","records_fake_r4"))
```

## Ingest data
Based on the path value specified above, we can now ingest either the real study dataset or the synthetic (fake) data. We perform a number of data transformations (using the `transform_csnl_example_ds` function) to prepare the dataset for analysis and then pair the dataset with its data dictionary, label the dataset and provide details of the unique identifier variable using the `YouthvarsProfile` module.

```{r}
A <- YouthvarsProfile(a_Ready4useDyad = Ready4useDyad(ds_tb = {
  if(!is.na(path_to_data_1L_chr)){readRDS(path_to_data_1L_chr)
    }else{repositories_ls$records_fake_r4 %>%
        ingest(fls_to_ingest_chr = c("SPECIFY_FILE_NAME_WHEN_WRITTEN"), # Synthetic dataset is not currently publicly available
               metadata_1L_lgl = F)}} %>% transform_csnl_example_ds(),
  dictionary_r3 = repositories_ls$aqol_real_r4 %>%
    ingest(fls_to_ingest_chr = c("ymh_clinical_aqol_chu_dict_r3"),
           metadata_1L_lgl = F)) %>%
  renew_Ready4useDyad(type_1L_chr = "label"),
                   id_var_nm_1L_chr = "fkClientID") # MODIFY WHEN READY4USE LIBRARY IS UPDATED
```

## Create utility mapping projects
We supply the dataset along with its metadata to two `TTUProject` modules - one to be used for mapping to adolescent AQoL-6D health utility and the other to map to CHU-9D health utility. Details about the former instrument can be automatically retrieved through use of `ScorzAqol6Adol` module. We change the default variable name for AQoL-6D health utility to the format preferred for predictors (all caps, no underscore) as this will be used as a candidate predictor for CHU-9D health utility later on. We manually record information about the CHU-9D instrument using the more generic `ScorzProfile` module. At the conclusion of this step we delete the object `A` that we previously created as it is no longer required.

```{r}
projects_ls <- list(AQOL_r4 = TTUProject(a_ScorzProfile = ScorzAqol6Adol(a_YouthvarsProfile = A, total_wtd_var_nm_1L_chr = "AQOL6D")) %>%
                      renewSlot("a_ScorzProfile@instrument_dict_r3",
                                .@a_ScorzProfile@instrument_dict_r3 %>%
                                  renew(filter_cdn_1L_chr = "var_nm_chr!='aqol6d_total_w'",
                                        var_nm_chr = "AQOL6D",
                                        var_ctg_chr = "utility overall score (final weighted)",
                                        var_desc_chr = "AQOL-6D (weighted total)",
                                        var_type_chr = "numeric") %>%
                                  dplyr::arrange(var_ctg_chr,var_nm_chr)),
                    CHU_r4 = TTUProject(a_ScorzProfile = ScorzProfile(a_YouthvarsProfile = A, country_1L_chr = "Australia",
                                                                      domain_wtd_var_nms_chr = renew(A@a_Ready4useDyad@dictionary_r3, filter_cdn_1L_chr = "startsWith(var_nm_chr,'chu9_')") %>%
                                                                        dplyr::pull(var_nm_chr) %>% as.character(),
                                                                      instrument_dict_r3 =  renew(A@a_Ready4useDyad@dictionary_r3,filter_cdn_1L_chr = "startsWith(var_nm_chr,'chu9_')|var_nm_chr=='CHU9D'"),
                                                                      instrument_nm_1L_chr = "Child Health Utility (9 Dimension)",instrument_short_nm_1L_chr = "CHU-9D",
                                                                      itm_labels_chr = c("worry", "sadness", "pain", "tiredness", "annoyance", "school", "sleep", "daily routine", "activities"),
                                                                      itm_prefix_1L_chr = "chu9_", total_wtd_var_nm_1L_chr = "CHU9D", total_unwtd_var_nm_1L_chr = "CHU_c")))
rm(A) 
```

## Verify health utility scores
Our source dataset includes total weighted utility scores for both utility instruments. We can verify the calculations for one of these instruments, the adolescent AQoL-6D, by comparing the calculations in our dataset to those generated from item responses using the `ScorzAqol6Adol`. We therefore apply the `ScorzAqol6Adol` scoring algorithm. We also add an unweighted total of all CHU-9D item responses as we will be using this later when descriptive plots are generated.

```{r}
projects_ls <- projects_ls %>%
  purrr::map(~renewSlot(.x,"a_ScorzProfile",{ #renewSlot(.x "a_ScorzProfile") # Will replace 
    if(inherits(.x@a_ScorzProfile,"ScorzAqol6Adol")){
      renew_ScorzAqol6Adol(.x@a_ScorzProfile) 
    }else{
      renew_ScorzProfile(.x@a_ScorzProfile)
    }
  })) 
```

We update the dataset copy with CHU-9D MAUI data so that it includes the AQoL totals that we calculated in the previous step.

```{r}
projects_ls$CHU_r4 <- renewSlot(projects_ls$CHU_r4,
                                "a_ScorzProfile@a_YouthvarsProfile@a_Ready4useDyad@ds_tb",
                                dplyr::left_join(procureSlot(projects_ls$CHU_r4, 
                                                              "a_ScorzProfile@a_YouthvarsProfile@a_Ready4useDyad@ds_tb"),
                                                  procureSlot(projects_ls$AQOL_r4, 
                                                              "a_ScorzProfile@a_YouthvarsProfile@a_Ready4useDyad@ds_tb") %>%
                                                    dplyr::select(projects_ls$AQOL_r4@a_ScorzProfile@a_YouthvarsProfile@id_var_nm_1L_chr,
                                                                  projects_ls$AQOL_r4@a_ScorzProfile@total_wtd_var_nm_1L_chr)))
```

Next we calculate the difference between the newly generated AQoL scores to those in our source dataset.

```{r}
projects_ls <- projects_ls %>%
  purrr::map(~renewSlot(.x,
                        "a_ScorzProfile@a_YouthvarsProfile@a_Ready4useDyad@ds_tb",
                        procureSlot(.x, "a_ScorzProfile@a_YouthvarsProfile@a_Ready4useDyad@ds_tb") %>%
                          dplyr::mutate(difference_aqol_calcs = AQOL6D - validation_aqol_w))) 
```

```{r}
# To manually inspect the validation statistic, uncomment and run the following two lines
# projects_ls$AQOL_r4@a_ScorzProfile@a_YouthvarsProfile@a_Ready4useDyad@ds_tb %>% dplyr::select(AQOL6D, validation_aqol_w, difference_aqol_calcs)
# projects_ls$AQOL_r4@a_ScorzProfile@a_YouthvarsProfile@a_Ready4useDyad@ds_tb$difference_aqol_calcs %>% summary()
```

# Describe and analyse data

## Specify modelling parameters

We begin by reorganising some of the metadata we have already specified about our dataset.

```{r}
projects_ls <- projects_ls %>% 
  purrr::map(~renewSlot(.x, "b_SpecificParameters", 
                        SpecificConverter(a_ScorzProfile = .x@a_ScorzProfile) %>%
                          metamorphose() %>%
                          procureSlot("b_SpecificParameters"))) 
```

We ingest from one of our online repositories a table describing the candidate predictors that we will explore.

```{r}
projects_ls <- projects_ls %>% 
  purrr::map2(repositories_ls[c("aqol_real_r4", "chu_real_r4")], 
              ~ renewSlot(.x, 
                         "b_SpecificParameters@predictors_lup",
                         ingest(.y, fls_to_ingest_chr = c("predictors_r3"), metadata_1L_lgl = F))) %>%  # 
  stats::setNames(names(projects_ls))
```

We now add the required parameters for allowable range for utility scores, the variable names of candidate predictors to be explored in the primary analysis, candidate covariates, and the variables to use when preparing descriptive statistics.

```{r}
projects_ls <- projects_ls %>% 
  purrr::map2(c(0.03,-0.1059), # Check that this is minimum value for CHU-9D
              ~ renewSlot(.x, "b_SpecificParameters@depnt_var_min_max_dbl", c(.y, 1)) %>% # Should be linked to ScorzClass
                renewSlot("b_SpecificParameters@candidate_predrs_chr", c("K10",
                                                                         #"MLT", 
                                                                         "SOFAS")) %>%
                renewSlot("b_SpecificParameters@candidate_covars_chr", c("d_age",  "d_gender",  
                                                                         "d_ATSI","d_CALD",
                                                                         "d_studying_working",
                                                                         "c_p_diag_grouped", #"c_clinical_staging_s",
                                                                         "c_days_oor", 
                                                                         "s_IRSD","s_remoteness"
                                                                         )) %>%
                renewSlot("b_SpecificParameters@descv_var_nms_chr", c("d_age","d_gender",
                                                                      "d_ATSI","d_CALD",
                                                                      "d_employment_type","d_studying", "d_studying_working",
                                                                      "c_days_cut_back", "c_days_unable", "c_days_oor",
                                                                      "c_p_diag_grouped", #"c_clinical_staging_s",
                                                                      "s_IRSD","s_remoteness"))) 
```

## Create local workspace
We create sub-directories where data generated by our analysis will be written. 

```{r}
projects_ls <- projects_ls %>% 
  purrr::map2(c("AQOL","CHU"),
              ~ {
                ready4::write_new_dirs(paste0(path_to_output_1L_chr,"/",.y),
                                       consent_1L_chr = "Y")
                X_TTUProject <- renewSlot(.x, "b_SpecificParameters@fake_1L_lgl", !is_real_1L_lgl)
                renewSlot(X_TTUProject,
                          "c_SpecificProject", 
                          SpecificModels(a_YouthvarsProfile = X_TTUProject@a_ScorzProfile@a_YouthvarsProfile,
                                            b_SpecificParameters = X_TTUProject@b_SpecificParameters,
                                            paths_chr = paste0(path_to_output_1L_chr,"/",.y)))
              }) 
```

We next confirm that our parameters and dataset are internally consistent. This step will also rename dataset variables that use naming conventions that are incompatible with rendering reports in subsequent steps.

```{r}
projects_ls <- projects_ls %>% 
  purrr::map(~ renewSlot(.x,
                          "c_SpecificProject",
                          ratify_SpecificModels(.x@c_SpecificProject)))  # Replace when Specific library is updated - ratifySlot(.x, "c_SpecificProject")
```

We now create additional sub-directories of the nominated output data directory.

```{r}
projects_ls <- projects_ls %>% 
  purrr::map(~ renewSlot(.x,
                          "c_SpecificProject",
                          authorSlot(.x, "c_SpecificProject", what_1L_chr = "workspace")))
```

We now generate tables and charts that describe our dataset. These are saved in a sub-directory of our output data directory.

```{r message=FALSE, results='hide', warning=FALSE}
projects_ls <- projects_ls %>% 
  purrr::map(~ {
    if(inherits(.x@a_ScorzProfile,"ScorzAqol6Adol")){ # Modify when fns exported
      x_labels_chr <-  manufacture_ScorzAqol6(.x@a_ScorzProfile, what_1L_chr = "domains")
      }else{
        x_labels_chr <- manufacture_ScorzProfile(.x@a_ScorzProfile, what_1L_chr = "domains", 
                                                 custom_args_ls = list(string = .x@b_SpecificParameters@itm_labels_chr), custom_fn = Hmisc::capitalize)
                }
                renewSlot(.x,
                          "c_SpecificProject",
                          # authorSlot(.x, "c_SpecificProject", 
                          #            what_1L_chr = "descriptives",
                          #            digits_1L_int = 3L)
                          author_SpecificModels(.x@c_SpecificProject,
                                                what_1L_chr = "descriptives",
                                                digits_1L_int = 3L,
                                                x_labels_chr = x_labels_chr))
                
              }) 
```

## Undertake exploratory modelling using baseline dataset

### Identify preferred model types
For each utility instrument, we next compare the performance of different model types. This step saves model objects and plots to a sub-directory of our output directory. When modelling, we constrain utility values to the range 0.00001 to 0.99999 (i.e. converting values outside this range to the nearest lower or upper bound) as this allows us to explore models with log transformations.

```{r message=FALSE, results='hide', warning=FALSE}
projects_ls <- projects_ls %>% 
  purrr::map(~ 
               renewSlot(.x, "c_SpecificProject",
               investigate_SpecificModels(.x@c_SpecificProject,
                                          depnt_var_max_val_1L_dbl = 0.99999,
                                          depnt_var_min_val_1L_dbl = 0.00001,
                                          session_ls = sessionInfo())
               # investigateSlot(.x, "c_SpecificProject",
               #                 depnt_var_max_val_1L_dbl = 0.99,
               #                 session_ls = sessionInfo())
               )) 
```

```{r}
# Note you can inspect the performance of models by uncommenting the following:
# exhibitSlot(projects_ls$AQOL_r4, "c_SpecificProject", what_1L_chr = "mdl_cmprsn", type_1L_chr = "results")
# exhibitSlot(projects_ls$CHU_r4, "c_SpecificProject", what_1L_chr = "mdl_cmprsn", type_1L_chr = "results")
```

```{r}
# To get the codes for the top performing models of each type you can uncomment the following code:
# projects_ls %>% purrr::map(~procureSlot(.x,"c_SpecificProject", use_procure_mthd_1L_lgl = T, what_1L_chr = "prefd_mdls"))
```

```{r}
# If these are not the models you plan on using you can look up the reference codes for other models from a table displayed when uncommenting and running the following:
# projects_ls$AQOL_r4@b_SpecificParameters@candidate_mdls_lup[,1:2]
```

After inspecting the comparisons of the models we have tested, we can now specify the preferred model types to use from this point onwards.

```{r message=FALSE, results='hide', warning=FALSE}
projects_ls <- projects_ls %>% 
  purrr::map(~ renewSlot(.x, "c_SpecificProject", renew(procureSlot(.x, "c_SpecificProject"),
                                                        new_val_xx = c("GLM_GSN_LOG", "OLS_CLL"), # Replace these codes as needed - see previous commented code.
                                                        type_1L_chr = "results", what_1L_chr = "prefd_mdls")))
```

### Identify preferred predictors and covariates
Next we assess multiple versions of our preferred model type - one single predictor model for each of our candidate predictors and the same models with candidate covariates added. A number of model/plot objects are saved to a sub-directory of our output directory. We specify the criterion that for each utility measure, candidate covariates must be significant parameters in all preferred models (the "all" value for `signft_covars_cndn_1L_chr`) to be considered for subsequent steps. To relax this condition, supply "any" instead of "all".

```{r message=FALSE, results='hide', warning=FALSE}
projects_ls <- projects_ls %>% 
  purrr::map(~ renewSlot(.x, "c_SpecificProject", 
                         #investigateSlot(A,"c_SpecificProject")
                         investigate_SpecificPredictors(.x@c_SpecificProject,
                                                        depnt_var_min_val_1L_dbl = 0.00001,
                                                        signft_covars_cndn_1L_chr = "all"))) 
```


```{r}
# Uncommenting the following code will allow inspection of the performance of the predictors.
# exhibit(projects_ls$AQOL_r4@c_SpecificProject, what_1L_chr = "predr_cmprsn", type_1L_chr = "results",scroll_box_args_ls = list(width = "100%"))
# exhibit(projects_ls$CHU_r4@c_SpecificProject, what_1L_chr = "predr_cmprsn", type_1L_chr = "results",scroll_box_args_ls = list(width = "100%"))
```

```{r}
# Uncommenting the following code will allow inspection of additional performance indictors of the predictors.
# exhibit(projects_ls$AQOL_r4@c_SpecificProject, type_1L_chr = "results", what_1L_chr = "fxd_sngl_cmprsn")
# exhibit(projects_ls$CHU_r4@c_SpecificProject, type_1L_chr = "results", what_1L_chr = "fxd_sngl_cmprsn")
```

```{r}
# Uncommenting the following code will allow identification of significant covariates.
# exhibit(projects_ls$AQOL_r4@c_SpecificProject, type_1L_chr = "results", what_1L_chr = "fxd_full_cmprsn", scroll_box_args_ls = list(width = "100%"))
# exhibit(projects_ls$CHU_r4@c_SpecificProject, type_1L_chr = "results", what_1L_chr = "fxd_full_cmprsn", scroll_box_args_ls = list(width = "100%"))
```
```{r}
# Covariates that were significant in all models can be returned by uncommenting the following
# purrr::map(projects_ls, ~procure(.x@c_SpecificProject, type_1L_chr = "results", what_1L_chr = "signt_covars"))
```


### Assess performance of final model specification 
After reviewing the output of the previous step, we specify the covariates we wish to add to the models. In the below example, we use the covariates that were automatically identified as meeting the criterion we specified earlier.

```{r message=FALSE, results='hide', warning=FALSE}
projects_ls <- projects_ls %>% 
  purrr::map(~ renewSlot(.x, "c_SpecificProject", 
                         renew(procureSlot(.x, "c_SpecificProject"),type_1L_chr = "results", what_1L_chr = "prefd_covars",
                               new_val_xx = procure(.x@c_SpecificProject, type_1L_chr = "results", what_1L_chr = "signt_covars"))))
# To manually over-ride the default selections, replace the value supplied to new_val_xx, e.g. new_val_xx = c("cdaysoor", "dage", if(inherits(.x@a_ScorzProfile,"ScorzAqol6Adol")){ "dgender"}),
```

```{r}
#ADD SECTION HERE TO RENAME COVARS
```



We now assess the multivariate models.  More model/plot objects are saved to a sub-directory of our output directory.

```{r message=FALSE, results='hide', warning=FALSE}
projects_ls <- projects_ls %>% 
  purrr::map(~ renewSlot(.x, "c_SpecificProject", investigate_SpecificFixed(.x@c_SpecificProject, depnt_var_min_val_1L_dbl = 0.00001))) #investigateSlot(.x, "c_SpecificProject")
```

## Create bayesian models for use in prediction
We next reformulate the models we finalised in the previous step as bayesian models that we will use when making predictions.

### Primary analysis
We first modify the default parameters used when creating the models to address potential convergence issues.

```{r}
projects_ls <- projects_ls %>% 
  purrr::map(~ renewSlot(.x, "c_SpecificProject@b_SpecificParameters@control_ls", list(adapt_delta = 0.98))) 
# This step may not be necessary owhen using the real data.
```

For our primary analysis, we use a baysesian formulation of the models we previously selected. A series of large model files are written to a sub-directory of the local output data directory.

```{r }
projects_ls <- projects_ls %>% 
  purrr::map(~ renewSlot(.x, "c_SpecificProject", investigate_SpecificMixed(.x@c_SpecificProject, depnt_var_min_val_1L_dbl = 0.00001))) ##investigateSlot(.x, "c_SpecificProject")
# A <- renewSlot(A, "c_SpecificProject",
#                investigate_SpecificMixed(A@c_SpecificProject)
#                #investigateSlot(A, "c_SpecificProject")
#                )
```

```{r}
#make_predr_vars_nms_ls needs updating! Only creating models with first significant covariate.
```

### Secondary analyses

For our secondary analyses, we will run our analysis algorithm using CHU-9D as a predictor for AQoL-6D.
```{r}
A@c_SpecificProject@a_YouthvarsProfile@a_Ready4useDyad@ds_tb <- A@c_SpecificProject@a_YouthvarsProfile@a_Ready4useDyad@ds_tb %>%dplyr::rename(CHU9D = chu9_total_w)
A@c_SpecificProject@a_YouthvarsProfile@a_Ready4useDyad@dictionary_r3 <- renew.ready4use_dictionary(A@c_SpecificProject@a_YouthvarsProfile@a_Ready4useDyad@dictionary_r3 %>% renew.ready4use_dictionary(filter_cdn_1L_chr = "var_nm_chr != 'chu9_total_w'"), var_nm_chr = "CHU9D", var_ctg_chr = "health_utility", var_desc_chr = "Child Health Utility (9 Dimension) total score", var_type_chr = "double")
A@c_SpecificProject@c_SpecificResults@b_SpecificPrivate@private_outp_ls$scored_data_tb <- A@c_SpecificProject@c_SpecificResults@b_SpecificPrivate@private_outp_ls$scored_data_tb %>% dplyr::rename(CHU9D = chu9_total_w)
A@c_SpecificProject@c_SpecificResults@a_SpecificShareable@shareable_outp_ls$dictionary_tb <- renew.ready4use_dictionary(A@c_SpecificProject@c_SpecificResults@a_SpecificShareable@shareable_outp_ls$dictionary_tb %>% renew.ready4use_dictionary(filter_cdn_1L_chr = "var_nm_chr != 'chu9_total_w'"), var_nm_chr = "CHU9D", var_ctg_chr = "health_utility", var_desc_chr = "Child Health Utility (9 Dimension) total score", var_type_chr = "double")
```


```{r }
A <- renewSlot(A, "c_SpecificProject",
               investigate_SpecificMixed(A@c_SpecificProject,
               #investigateSlot(A, "c_SpecificProject",
                               scndry_anlys_params_ls = make_scndry_anlys_params(candidate_predrs_chr = c("CHU9D"),
                                                                                 candidate_covar_nms_chr = c("dage", "cdayscutback", "cdaysunable"),
                                                                                 prefd_covars_chr = NA_character_,
                                                                                 predictors_lup = A@b_SpecificParameters@predictors_lup %>%
                                                                                   specific::renew.specific_predictors(short_name_chr = "CHU9D",
                                                                                                                       long_name_chr = "CHU-9D utility",
                                                                                                                       min_val_dbl = 0,
                                                                                                                       max_val_dbl = 0,
                                                                                                                       class_chr = "numeric",
                                                                                                                       increment_dbl = 0.05,
                                                                                                                       class_fn_chr = "as.double",
                                                                                                                       mdl_scaling_dbl = 1,
                                                                                                                       covariate_lgl = F))))
```

# Report and disseminate findings

## Create shareable models
The model objects created and saved in our working directory by the preceding steps are not suitable for public dissemination. They are both too large in file size and, more importantly, include copies of our source dataset. We can overcome these limitations by creating shareable versions of the models. Two types of shareable version are created - copies of the original model objects in which fake data overwrites the original source data and tables of model coefficients.

```{r}
A <- renewSlot(A, "c_SpecificProject",
               authorData_SpecificMixed(procureSlot(A, "c_SpecificProject"))) #authorData
```

# Specify study reporting metadata
We create a `TTUSynopsis` object that contains the fields necessary to render and share reports.

```{r}
A <- renewSlot(A, "d_TTUReports",
               {
                 Y <- metamorphoseSlot(A, "c_SpecificProject")
                 Y <- TTUSynopsis(a_Ready4showPaths = Y@a_Ready4showPaths,
                                  b_SpecificResults = Y@b_SpecificResults,
                                  c_SpecificParameters = Y@c_SpecificParameters,
                                  d_YouthvarsProfile = Y@d_YouthvarsProfile,
                                  rmd_fl_nms_ls = Y@rmd_fl_nms_ls)
                 Y <- TTUReports(a_TTUSynopsis = Y)
                 Y
                 }
               )
```

We add metadata relevant to the reports that we will be generating to these fields. Note that the data we supply to the Ready4useRepos module below must relate to a repository to which we have write permissions (otherwise subsequent steps will fail). If you do not have write permissions to the dataverse dataset specified below, you can instead supply values relating to a repository that you do have write permissions to. Alternatively, you can skip any subsequent `share` or `shareSlot` commands that involve writing data to the online data repository.

```{r eval =F}
A <- renewSlot(A, "d_TTUReports@a_TTUSynopsis",
               procureSlot(A, "d_TTUReports@a_TTUSynopsis") %>% 
                 renewSlot("authors_r3", 
                           {if(A@b_SpecificParameters@fake_1L_lgl){ready4show::authors_tb}else{read.csv("CSVs/Authors.csv") %>% 
                               tibble::as_tibble() %>% ready4show::ready4show_authors()}}) %>%
                 renewSlot("institutes_r3", 
                           {if(A@b_SpecificParameters@fake_1L_lgl){ready4show::institutes_tb }else{
                               read.csv("CSVs/Institutes.csv") %>% tibble::as_tibble() %>% ready4show::ready4show_institutes()}}) %>%
                 renewSlot("digits_int", c(3L,3L)) %>%
                 renewSlot("outp_formats_chr", c("PDF","PDF")) %>%
                 renewSlot("title_1L_chr", 
                           ifelse(A@b_SpecificParameters@fake_1L_lgl,paste0("A hypothetical study using fake data", "to map psychological distress and functioning measures to adolescent AQoL-6D utility"),
                                  "Mapping psychological distress and functioning measures to adolescent AQoL-6D utility using data from a sample of young people presenting to primary mental health services")) %>%
                 #renewSlot("correspondences_r3", old_nms_chr = c("PHQ9", "GAD7"), new_nms_chr = c("PHQ-9", "GAD-7")) %>%
                 renewSlot("e_Ready4useRepos", 
                           Ready4useRepos(dv_nm_1L_chr = "TTU", 
                                          dv_ds_nm_1L_chr = ifelse(A@b_SpecificParameters@fake_1L_lgl,"https://doi.org/10.7910/DVN/LYBMB0", "https://doi.org/10.7910/DVN/FDRUXH"), 
                                          dv_server_1L_chr = "dataverse.harvard.edu"))) 
```

## Describe and share models

### Author model catalogues
We download a program for generating a catalogue of models and use it to summarising the models created under each study analysis (one primary and two secondary). The catalogues are saved locally.

```{r}
author_TTUReports(A@d_TTUReports, what_1L_chr = "Catalogue", download_tmpl_1L_lgl = F#, subtitle_1L_chr = "Catalogue of models"
                  )
#authorSlot(A, "d_TTUReports", what_1L_chr = "Catalogue", download_tmpl_1L_lgl = T, subtitle_1L_chr = "Catalogue of models") # Need to update catalogue RMD
```

### Share model catalogue
We share the catalogues that we created, uploading a copy to our study online repository. To run this step you will need write permissions to the online repository.

```{r}
shareSlot(A, "d_TTUReports@a_TTUSynopsis", type_1L_chr = "Report", what_1L_chr = "Catalogue") # May get an error message - can ignore so long as files uploaded.
```

### Share models
We share tables of coefficients and other meta-data about the models we have created by posting them to the online repository. The object we create and share is designed to be used in conjunction with the `youthu` package to make it easier to make predictions with these models using new data. Again, you will need write permissions to the online repository.

```{r}
shareSlot(A, "d_TTUReports@a_TTUSynopsis", type_1L_chr = "Models", what_1L_chr = "ingredients")
```

## Author manuscript
We add some content about the manuscript we wish to author.

```{r eval =F}
A <- renewSlot(A, "d_TTUReports@a_TTUSynopsis",
               procureSlot(A, "d_TTUReports@a_TTUSynopsis") %>% 
                 renewSlot("background_1L_chr", 
                           "Quality Adjusted Life Years (QALYs) are often used in economic evaluations, yet utility weights for deriving them are rarely directly measured in mental health services.") %>%
                 renewSlot("coi_1L_chr", "None declared") %>%
                 renewSlot("conclusion_1L_chr", 
                           ifelse(A@b_SpecificParameters@fake_1L_lgl, 
                                  "Nothing should be concluded from this study as it is purely hypothetical.",
                                  "To be written on review of real data")) %>%
                 renewSlot("ethics_1L_chr", 
                           paste0("The study was reviewed and granted approval by ", 
                                  ifelse(A@b_SpecificParameters@fake_1L_lgl,"no-one.",
                                         "the University of Melbourneâ€™s Human Research Ethics Committee and the local Human Ethics and Advisory Group (ADD NUMBER HERE"))) %>%
                 renewSlot("funding_1L_chr", 
                           paste0("The study was funded by ",
                                  ifelse(A@b_SpecificParameters@fake_1L_lgl,"no-one.",
                                         "the National Health and Medical Research Council (NHMRC, ADD ID HERE), Orygen and headspace."))) %>%
                 #renewSlot("interval_chr", "three months") %>%
                 renewSlot("keywords_chr", 
                           c("AQoL","functioning", "psychological distress", "QALYs", "utility mapping")) %>%
                 renewSlot("sample_desc_1L_chr", 
                           ifelse(A@b_SpecificParameters@fake_1L_lgl, "The study sample is fake data.","")) )
```

We create a summary of the study that can be interpreted by the program that authors the manuscript.

```{r eval =F}
A <- renewSlot(A, "d_TTUReports@a_TTUSynopsis@abstract_args_ls",
               #manufactureSlot(A,"d_TTUReports@a_TTUSynopsis", 
                manufacture_SpecificSynopsis(A@d_TTUReports@a_TTUSynopsis,
                                             what_1L_chr = "abstract_args_ls",
                                             depnt_var_nms_chr = c("AQoL-6D", "Adolescent AQoL Six Dimension"))) 
```

```{r eval =F}
A@d_TTUReports@a_TTUSynopsis <- enhance_SpecificSynopsis(A@d_TTUReports@a_TTUSynopsis, # A <- enhanceSlot(A, "d_TTUReports@a_TTUSynopsis", 
                 with_1L_chr = "results_ls",
                 depnt_var_nms_chr = c("AQoL-6D", "Adolescent AQoL Six Dimension")) 
```

We create and save the plots that will be used in the manuscript.

```{r}
#authorSlot(A, "d_TTUReports",
author_TTUReports(A@d_TTUReports,           
           type_1L_chr = "Plots",
           depnt_var_desc_1L_chr = A@d_TTUReports@a_TTUSynopsis@b_SpecificResults@a_SpecificShareable@shareable_outp_ls$results_ls$study_descs_ls$health_utl_nm_1L_chr)
```

We download a program for generating a template manuscript and run it to author an algorithm authored first draft of the manuscript.

```{r}
authorSlot(A, "d_TTUReports", type_1L_chr = "Report", what_1L_chr = "Manuscript_Auto", download_tmpl_1L_lgl = F)#T
```

```{r echo=FALSE}
#author_TTUReports(A@d_TTUReports, type_1L_chr = "Dependencies", what_1L_chr = "Manuscript_Auto")
```

# Tidy workspace
The preceding steps saved multiple objects (mostly R model objects) that have embedded within them copies of the source dataset. We can now purge all such copies from our output data directory.

```{r}
#author(procureSlot(A,"c_SpecificProject"), type_1L_chr = "purge_write") 
```