
---
output: 
  bookdown::pdf_document2:
    includes:
      in_header: preamble.tex
    pandoc_args: 
      - "--metadata-file=../Header/header_common.yaml"
      - '--lua-filter=../Filters/scholarly-metadata.lua'
      - '--lua-filter=../Filters/author-info-blocks.lua'
    toc: no
date: "`r format(Sys.Date(),'%d %B %Y')`"
params:
  eval_1L_lgl: True
  X: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = params$eval_1L_lgl)
```

\blandscape
<!---BLOCK_LANDSCAPE_START--->

# About this code
When using this code it is important to note:

1) Some of the steps in this program involve interactivity - they generate a prompt that a user must respond to before proceeding. Therefore, this code should be run step by step (i.e run one chunk at a time and do not knit if you are using the kdown version of this code).

2) The code is implemented in R using [ready4 framework](https://ready4-dev.github.io/ready4/) modules for

- labeling, validating and summarising youth mental health datasets from the [youthvars](https://ready4-dev.github.io/youthvars/) package;
- scoring health utility from the [scorz](https://ready4-dev.github.io/scorz/) package;
- specifying and testing statistical models from the [specific](https://ready4-dev.github.io/specific/) package;
- generating reports from the [ready4show](https://ready4-dev.github.io/ready4show/)  package; and
- sharing data via online data repositories from the [ready4use](https://ready4-dev.github.io/ready4use/)  package; and
- implementing a utility mapping study from the [TTU](https://ready4-dev.github.io/TTU/) package.

3) The code in this program is highly abstracted which means that its detailed workings are not exposed. However, as all code is open source you are able to scrutinise the underlying code if you wish. The websites, manuals and repositories of the ready4 framework libraries used in this analysis are a good starting point. 

# Install and load required libraries
If you do not already have the required libraries to run this program installed, you can do so by un-commenting and running the following lines.

```{r }
# devtools::install_github("ready4-dev/ready4) 
# devtools::install_github("ready4-dev/TTU") 
```

Next load the libraries required to run this program.

```{r message=FALSE, warning=FALSE}
library(ready4)
library(ready4use)
library(youthvars)
library(scorz)
library(TTU)
```

Source functions that we will use later.

```{r}
source("../R/Functions.R")
```

# Ingest, transform, label and score data

## Ingest data
To start, we need to specify the path to our input dataset. The setting below (empty) will allow you to run the program for an illustrative **replication** study using a synthetic dataset that, though entirely fake, closely resembles the study dataset. However, if you have access to the source dataset and wish to use it to **reproduce** our study, you can instead specify the path to that data here.

```{r eval=FALSE}
#path_to_data_1L_chr <- NA_character_ # Replace with path to data if you have access to it
```

Based on the value specified above, we can now ingest either the real study dataset or the synthetic (fake) data. We perform a number of data transformations (using the `transform_csnl_example_ds` function) to prepare the dataset for analysis and then pair the dataset with its data dictionary as a `Ready4useDyad`.

```{r}
A <- Ready4useDyad(ds_tb = {if(!is.na(path_to_data_1L_chr)){readRDS(path_to_data_1L_chr)
  }else{Ready4useRepos(dv_nm_1L_chr = "fakes",
                       dv_ds_nm_1L_chr = "https://doi.org/10.7910/DVN/HJXYKQ",
                       dv_server_1L_chr = "dataverse.harvard.edu") %>%
      ingest(fls_to_ingest_chr = c("SPECIFY_FILE_NAME_WHEN_WRITTEN"),
             metadata_1L_lgl = F)}} %>% transform_csnl_example_ds(),
  dictionary_r3 = Ready4useRepos(dv_nm_1L_chr = "TTU",
                                 dv_ds_nm_1L_chr = "https://doi.org/10.7910/DVN/FDRUXH",
                                 dv_server_1L_chr = "dataverse.harvard.edu") %>%
    ingest(fls_to_ingest_chr = c("ymh_clinical_aqol_chu_dict_r3"),
           metadata_1L_lgl = F)
  ) 
A <- A %>%
  renew_Ready4useDyad(type_1L_chr = "label") # MODIFY WHEN READY4USE LIBRARY IS UPDATED
```

We add some metadata about the structural properties of our dataset (variables for the unique record identifier and data collection round), using the `YouthvarsProfile` module.

```{r}
A <- YouthvarsProfile(a_Ready4useDyad = A,
                      id_var_nm_1L_chr = "fkClientID")
```


## Score health utility
We calculate adolescent AQoL-6D scores using the `ScorzAqol6Adol` module and save the dataset along with its metadata as a `TTUProject` module.

```{r}
A <- TTUProject(a_ScorzProfile = ScorzAqol6Adol(a_YouthvarsProfile = A))
#A <- renewSlot(A, "a_ScorzProfile") # Will replace subsequent line
A@a_ScorzProfile <- renew_ScorzAqol6Adol(A@a_ScorzProfile) # This is temporary
```

# Describe and analyse data

## Specify modelling parameters

We begin by reorganising some of the metadata we have already specified about our dataset.

```{r}
A <- renewSlot(A, "b_SpecificParameters", SpecificConverter(a_ScorzProfile = A@a_ScorzProfile) %>%
                 metamorphose() %>%
                 procureSlot("b_SpecificParameters"))
```

We add a table describing the candidate predictors that we will explore.

```{r}
# A <- renewSlot(A, "b_SpecificParameters@predictors_lup", Ready4useRepos(dv_nm_1L_chr = "TTU", 
#                                                                         dv_ds_nm_1L_chr = "https://doi.org/10.7910/DVN/FDRUXH", 
#                                                                         dv_server_1L_chr = "dataverse.harvard.edu") %>%
#                  ingest(fls_to_ingest_chr = c("predictors_r3"),
#                         metadata_1L_lgl = F)) 
A@b_SpecificParameters@predictors_lup <- make_csnl_example_predrs() # Temporary - Prior code preferred once scaling factor fixed.
```

We add the required parameters (allowable range for utility scores, the variable names of candidate predictors to be explored in the primary analysis, candidate covariates, variables to use when preparing descriptive statistics, the data collection date-stamp variable and metadata on candidate predictors).

```{r}
A <- renewSlot(A, "b_SpecificParameters@depnt_var_min_max_dbl", c(0.03,1)) %>% # Should be linked to ScorzClass
  renewSlot("b_SpecificParameters@candidate_predrs_chr", c("K10", "MLT", "SOFAS")) %>%
  renewSlot("b_SpecificParameters@candidate_covars_chr", c("d_gender", "d_age",  #"d_sexual_ori_s", 
                                                           "d_ATSI","CALD",
                                                           "c_days_cut_back",   "c_days_unable", 
                                                           #"d_studying_working", 
                                                           "c_p_diag_s" #"c_clinical_staging_s",
                                                          # "SOFAS"
                                                           )) %>%
  renewSlot("b_SpecificParameters@descv_var_nms_chr", c("d_age","d_gender",
                                                        "c_days_cut_back",   "c_days_unable", 
                                                        "d_employment_type","d_studying",#"d_studying_working", 
                                                        "c_p_diag_s", #"c_clinical_staging_s",
                                                        "s_IRSD","s_remoteness"
                                                        #"SOFAS"
                                                        )) 
# %>%  renewSlot("b_SpecificParameters@msrmnt_date_var_nm_1L_chr", "d_interview_date") 
```

## Create local workspace
We add details of the directory where data generated by our analysis will be written. Note, if using real data **this must be a secure location** as copies of the dataset will be saved in this directory.

```{r}
A <-  renewSlot(A, "b_SpecificParameters@fake_1L_lgl", T#ifelse(is.na(path_to_data_1L_chr),T,F)
                ) 
```
```{r}
A <- renewSlot(A, "c_SpecificProject", SpecificModels(a_YouthvarsProfile = A@a_ScorzProfile@a_YouthvarsProfile,
                                                      b_SpecificParameters = A@b_SpecificParameters,
                                                      paths_chr = {
                                                        if(is.na(path_to_data_1L_chr)){
                                                          tempdir()
                                                          }else{
                                                           normalizePath("../Data")
                                                          }
                                                        })) 
```

We confirm that our parameters and dataset are internally consistent. This step will also rename dataset variables that use certain incompatible naming conventions.

```{r}
A@c_SpecificProject <- ratify_SpecificModels(A@c_SpecificProject) # Delete when Specific library is updated
#A <- ratifySlot(A, "c_SpecificProject")
```

We now begin to create sub-directories of the nominated output data directory.

```{r}
A <- renewSlot(A, "c_SpecificProject", 
               authorSlot(A, "c_SpecificProject", what_1L_chr = "workspace"))
```

We now generate tables and charts that describe our dataset. These are saved in a sub-directory of our output data directory.

```{r message=FALSE, results='hide', warning=FALSE}
A <- renewSlot(A, "c_SpecificProject",
               # authorSlot(A, "c_SpecificProject", 
               #            what_1L_chr = "descriptives",
               #            digits_1L_int = 3L)
               author_SpecificModels(A@c_SpecificProject,
                                     what_1L_chr = "descriptives",
                                     digits_1L_int = 3L)
               
               )
```

## Undertake exploratory modelling using baseline dataset

### Identify preferred model types
We next compare the performance of different model types. This step saves model objects and plots to a sub-directory of our output directory.

```{r message=FALSE, results='hide', warning=FALSE}
A <- renewSlot(A, "c_SpecificProject",
               investigate_SpecificModels(A@c_SpecificProject,
                                          depnt_var_max_val_1L_dbl = 0.99,
                                          session_ls = sessionInfo())
               # investigateSlot(A, "c_SpecificProject",
               #                 depnt_var_max_val_1L_dbl = 0.99,
               #                 session_ls = sessionInfo())
               )
```

```{r}
# Note you can inspect the performance of models by uncommenting the following:
# exhibitSlot(A,"c_SpecificProject",
#         what_1L_chr = "mdl_cmprsn",
#         type_1L_chr = "results"
#         ) 
```

```{r}
# To get the codes for the top performing models of each type you can uncomment the following code:
# procureSlot(A,"c_SpecificProject",
#         use_procure_mthd_1L_lgl = T,
#         what_1L_chr = "prefd_mdls")
```

```{r}
# If these are not the models you plan on using you can look up the codes from a table displayed when uncommenting and running the following:
#A@b_SpecificParameters@candidate_mdls_lup[,1:2]
```


After inspecting the output of the previous command, we can now specify the preferred model types to use from this point onwards.

```{r message=FALSE, results='hide', warning=FALSE}
A <- renewSlot(A, "c_SpecificProject",
               renew(procureSlot(A, "c_SpecificProject"),
                     new_val_xx = c("GLM_GSN_LOG", "OLS_CLL"), # Replace these codes as needed - see previous commented code.
                     type_1L_chr = "results",
                     what_1L_chr = "prefd_mdls"))
```

### Identify preferred predictors and covariates
Next we assess multiple versions of our preferred model type - one single predictor model for each of our candidate predictors and the same models with candidate covariates added. A number of model/plot objects saved to a sub-directory of our output directory.

```{r message=FALSE, results='hide', warning=FALSE}
A <- renewSlot(A, "c_SpecificProject",
               #investigateSlot(A,"c_SpecificProject")
               investigate_SpecificPredictors(A@c_SpecificProject)
               )
```


```{r}
# Uncommenting the following code will allow inspection of the performance of the predictors.
# exhibit(A@c_SpecificProject,
#         what_1L_chr = "predr_cmprsn",
#         type_1L_chr = "results",
#         scroll_box_args_ls = list(width = "100%"))
```

```{r}
# Uncommenting the following code will allow inspection of additional performance indictors of the predictors.
# exhibit(A@c_SpecificProject,
#         type_1L_chr = "results",
#         what_1L_chr = "fxd_sngl_cmprsn")
```

```{r}
# Uncommenting the following code will allow identification of significant covariates.
# exhibit(A@c_SpecificProject,
#         type_1L_chr = "results",
#         what_1L_chr = "fxd_full_cmprsn",
#         scroll_box_args_ls = list(width = "100%"))
```
```{r}
# Covariates that were significant in all models can be returned by uncommenting the following
# procure(A@c_SpecificProject,
#         type_1L_chr = "results",
#         what_1L_chr = "signt_covars")
```


### Assess performance of final model specification 
After reviewing the output of the previous step, we specify the covariates we wish to add to the models.

```{r message=FALSE, results='hide', warning=FALSE}
A <- renewSlot(A, "c_SpecificProject",
               renew(procureSlot(A, "c_SpecificProject"),
                     new_val_xx = c("dage", "cdayscutback", "cdaysunable"), # Modify based on manual inspection in previous steps.
                     type_1L_chr = "results",
                     what_1L_chr = "prefd_covars"))
```

We now assess the multivariate models.  More model/plot objects are saved to a sub-directory of our output directory.

```{r message=FALSE, results='hide', warning=FALSE}
A <- renewSlot(A, "c_SpecificProject",
               investigateSlot(A, "c_SpecificProject"))
```

## Create bayesian models for use in prediction
We next reformulate the models we finalised in the previous step as bayesian models that we will use when making predictions.

### Primary analysis
We first modify the default parameters used when creating the models to address potential convergence issues.

```{r}
A <- renewSlot(A,"c_SpecificProject@b_SpecificParameters@control_ls", # This step may not be necessary on the real data.
               new_val_xx = list(adapt_delta = 0.95))
```


For our primary analysis, we use the longitudinal formulation of the models we previously selected. A series of large model files are written to a sub-directory of the local output data directory.

```{r }
A <- renewSlot(A, "c_SpecificProject",
               investigate_SpecificMixed(A@c_SpecificProject)
               #investigateSlot(A, "c_SpecificProject")
               )
```

```{r}
#make_predr_vars_nms_ls needs updating! Only creating models with first significant covariate.
```

### Secondary analyses

For our secondary analyses, we will run our analysis algorithm using CHU-9D as a predictor for AQoL-6D.
```{r}
A@c_SpecificProject@a_YouthvarsProfile@a_Ready4useDyad@ds_tb <- A@c_SpecificProject@a_YouthvarsProfile@a_Ready4useDyad@ds_tb %>%dplyr::rename(CHU9D = chu9_total_w)
A@c_SpecificProject@a_YouthvarsProfile@a_Ready4useDyad@dictionary_r3 <- renew.ready4use_dictionary(A@c_SpecificProject@a_YouthvarsProfile@a_Ready4useDyad@dictionary_r3 %>% renew.ready4use_dictionary(filter_cdn_1L_chr = "var_nm_chr != 'chu9_total_w'"), var_nm_chr = "CHU9D", var_ctg_chr = "health_utility", var_desc_chr = "Child Health Utility (9 Dimension) total score", var_type_chr = "double")
A@c_SpecificProject@c_SpecificResults@b_SpecificPrivate@private_outp_ls$scored_data_tb <- A@c_SpecificProject@c_SpecificResults@b_SpecificPrivate@private_outp_ls$scored_data_tb %>% dplyr::rename(CHU9D = chu9_total_w)
A@c_SpecificProject@c_SpecificResults@a_SpecificShareable@shareable_outp_ls$dictionary_tb <- renew.ready4use_dictionary(A@c_SpecificProject@c_SpecificResults@a_SpecificShareable@shareable_outp_ls$dictionary_tb %>% renew.ready4use_dictionary(filter_cdn_1L_chr = "var_nm_chr != 'chu9_total_w'"), var_nm_chr = "CHU9D", var_ctg_chr = "health_utility", var_desc_chr = "Child Health Utility (9 Dimension) total score", var_type_chr = "double")
```


```{r }
A <- renewSlot(A, "c_SpecificProject",
               investigate_SpecificMixed(A@c_SpecificProject,
               #investigateSlot(A, "c_SpecificProject",
                               scndry_anlys_params_ls = make_scndry_anlys_params(candidate_predrs_chr = c("CHU9D"),
                                                                                 candidate_covar_nms_chr = c("dage", "cdayscutback", "cdaysunable"),
                                                                                 prefd_covars_chr = NA_character_,
                                                                                 predictors_lup = A@b_SpecificParameters@predictors_lup %>%
                                                                                   specific::renew.specific_predictors(short_name_chr = "CHU9D",
                                                                                                                       long_name_chr = "CHU-9D utility",
                                                                                                                       min_val_dbl = 0,
                                                                                                                       max_val_dbl = 0,
                                                                                                                       class_chr = "numeric",
                                                                                                                       increment_dbl = 0.05,
                                                                                                                       class_fn_chr = "as.double",
                                                                                                                       mdl_scaling_dbl = 1,
                                                                                                                       covariate_lgl = F))))
```

# Report and disseminate findings

## Create shareable models
The model objects created and saved in our working directory by the preceding steps are not suitable for public dissemination. They are both too large in file size and, more importantly, include copies of our source dataset. We can overcome these limitations by creating shareable versions of the models. Two types of shareable version are created - copies of the original model objects in which fake data overwrites the original source data and tables of model coefficients.

```{r}
A <- renewSlot(A, "c_SpecificProject",
               authorData_SpecificMixed(procureSlot(A, "c_SpecificProject"))) #authorData
```

# Specify study reporting metadata
We create a `TTUSynopsis` object that contains the fields necessary to render and share reports.

```{r}
A <- renewSlot(A, "d_TTUReports",
               {
                 Y <- metamorphoseSlot(A, "c_SpecificProject")
                 Y <- TTUSynopsis(a_Ready4showPaths = Y@a_Ready4showPaths,
                                  b_SpecificResults = Y@b_SpecificResults,
                                  c_SpecificParameters = Y@c_SpecificParameters,
                                  d_YouthvarsProfile = Y@d_YouthvarsProfile,
                                  rmd_fl_nms_ls = Y@rmd_fl_nms_ls)
                 Y <- TTUReports(a_TTUSynopsis = Y)
                 Y
                 }
               )
```

We add metadata relevant to the reports that we will be generating to these fields. Note that the data we supply to the Ready4useRepos module below must relate to a repository to which we have write permissions (otherwise subsequent steps will fail). If you do not have write permissions to the dataverse dataset specified below, you can instead supply values relating to a repository that you do have write permissions to. Alternatively, you can skip any subsequent `share` or `shareSlot` commands that involve writing data to the online data repository.

```{r eval =F}
A <- renewSlot(A, "d_TTUReports@a_TTUSynopsis",
               procureSlot(A, "d_TTUReports@a_TTUSynopsis") %>% 
                 renewSlot("authors_r3", 
                           {if(A@b_SpecificParameters@fake_1L_lgl){ready4show::authors_tb}else{read.csv("CSVs/Authors.csv") %>% 
                               tibble::as_tibble() %>% ready4show::ready4show_authors()}}) %>%
                 renewSlot("institutes_r3", 
                           {if(A@b_SpecificParameters@fake_1L_lgl){ready4show::institutes_tb }else{
                               read.csv("CSVs/Institutes.csv") %>% tibble::as_tibble() %>% ready4show::ready4show_institutes()}}) %>%
                 renewSlot("digits_int", c(3L,3L)) %>%
                 renewSlot("outp_formats_chr", c("PDF","PDF")) %>%
                 renewSlot("title_1L_chr", 
                           ifelse(A@b_SpecificParameters@fake_1L_lgl,"A hypothetical study using fake data",
                                  "Mapping psychological distress and functioning measures to adolescent AQoL-6D utility using data from a sample of young people presenting to primary mental health services")) %>%
                 #renewSlot("correspondences_r3", old_nms_chr = c("PHQ9", "GAD7"), new_nms_chr = c("PHQ-9", "GAD-7")) %>%
                 renewSlot("e_Ready4useRepos", 
                           Ready4useRepos(dv_nm_1L_chr = "TTU", 
                                          dv_ds_nm_1L_chr = ifelse(A@b_SpecificParameters@fake_1L_lgl,"https://doi.org/10.7910/DVN/LYBMB0", "https://doi.org/10.7910/DVN/FDRUXH"), 
                                          dv_server_1L_chr = "dataverse.harvard.edu"))) 
```

## Describe and share models

### Author model catalogues
We download a program for generating a catalogue of models and use it to summarising the models created under each study analysis (one primary and two secondary). The catalogues are saved locally.

```{r}
authorSlot(A, "d_TTUReports", what_1L_chr = "Catalogue", download_tmpl_1L_lgl = T, subtitle_1L_chr: "Catalogue of models")
```
